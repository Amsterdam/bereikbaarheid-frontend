suite: ServiceAccounts
release:
  name: test
templates:
  - serviceaccount.yaml
tests:
  - it: should have release name as postfix
    set:
      serviceAccounts:
        my-sa: {}
    asserts:
      - isKind:
          of: ServiceAccount
      - matchRegex:
          path: metadata.name
          pattern: -test$

  - it: should always have a default service account
    set:
    asserts:
      - hasDocuments:
          count: 1

      - notExists:
          path: metadata.labels['azure.workload.identity/use']
        
      - notExists:
          path: metadata.annotations['azure.workload.identity/client-id']

  - it: should be possible to use workload identity on the default service account
    set:
      workloadIdentity: default-client-id
    asserts:
      - equal:
          path: metadata.labels['azure.workload.identity/use']
          value: "true"
      - equal:
          path: metadata.annotations['azure.workload.identity/client-id']
          value: default-client-id

  - it: should be possible to override workloadIdentity client id
    set:
      workloadIdentity: default-client-id
      serviceAccounts:
        my-sa:
          workloadIdentity: my-client-id
    asserts:
      - hasDocuments:
          count: 2

      - documentIndex: 0
        equal:
          path: metadata.labels['azure.workload.identity/use']
          value: "true"
        
      - documentIndex: 0
        equal:
          path: metadata.annotations['azure.workload.identity/client-id']
          value: default-client-id

      - documentIndex: 1
        equal:
          path: metadata.labels['azure.workload.identity/use']
          value: "true"
        
      - documentIndex: 1
        equal:
          path: metadata.annotations['azure.workload.identity/client-id']
          value: my-client-id
        

  - it: should be possible to disable workload identity
    set:
      workloadIdentity: default-client-id
      serviceAccounts:
        my-sa:
          enableWorkloadIdentity: false
    asserts:
      - hasDocuments:
          count: 2

      - documentIndex: 0
        equal:
          path: metadata.labels['azure.workload.identity/use']
          value: "true"
        
      - documentIndex: 0
        equal:
          path: metadata.annotations['azure.workload.identity/client-id']
          value: default-client-id

      - documentIndex: 1
        notExists:
          path: metadata.labels['azure.workload.identity/use']
        
      - documentIndex: 1
        notExists:
          path: metadata.annotations['azure.workload.identity/client-id']
        
